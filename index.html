<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tic Tac Toe — PWA</title>
    <meta
      name="description"
      content="Tic Tac Toe sederhana sebagai PWA dengan Tailwind CSS"
    />

    <!-- Link to the manifest (save manifest.json next to this file) -->
    <link rel="manifest" href="./manifest.json" />

    <style>
      /* Small tweak to make the board buttons square */
      .cell {
        aspect-ratio: 1 / 1;
      }
    </style>
    <script>
      if ('serviceWorker' in navigator) {
       navigator.serviceWorker.register('./sw.js').then(function(reg) {
          console.log('Service Worker registered with scope:', reg.scope);
        }).catch(function(error) {
          console.log('Service Worker registration failed:', error);
        });
      }
    </script>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Tic Tac Toe</h1>
        <p class="subtitle">Sederhana · Offline-ready · CSS Responsive</p>
      </header>

      <main>
        <div class="score-turn">
          <div>
            <div class="label">Giliran:</div>
            <div id="turn" class="turn">X</div>
          </div>
          <div class="score">
            <div class="label">Skor</div>
            <div class="score-value">
              X: <span id="score-x">0</span> — O: <span id="score-o">0</span>
            </div>
          </div>
        </div>

        <div id="board" class="board">
          <!-- 9 cells generated by JS -->
        </div>

        <div class="actions">
          <button id="restart" class="btn btn-primary">Restart</button>
          <button id="resetScore" class="btn btn-secondary">Reset Skor</button>
        </div>

        <div class="status" id="status">
          Petunjuk: Klik kotak untuk memainkan. Aplikasi ini bisa dipasang
          sebagai PWA.
        </div>

        <div class="install">
          <button id="installBtn" class="btn btn-install hidden">
            Install PWA
          </button>
        </div>
      </main>

      <footer>Made with ❤️ — Offline caching via service worker</footer>
    </div>

    <script>
      // Game state
      const boardEl = document.getElementById("board");
      const turnEl = document.getElementById("turn");
      const statusEl = document.getElementById("status");
      const scoreXEl = document.getElementById("score-x");
      const scoreOEl = document.getElementById("score-o");
      const restartBtn = document.getElementById("restart");
      const resetScoreBtn = document.getElementById("resetScore");
      const installBtn = document.getElementById("installBtn");

      let board = Array(9).fill(null);
      let current = "X";
      let scores = { X: 0, O: 0 };

      // Load scores from localStorage
      try {
        const saved = JSON.parse(localStorage.getItem("ttt-scores"));
        if (saved) scores = saved;
      } catch (e) {}
      scoreXEl.textContent = scores.X;
      scoreOEl.textContent = scores.O;

      function createBoard() {
        boardEl.innerHTML = "";
        for (let i = 0; i < 9; i++) {
          const btn = document.createElement("button");
          btn.className = "cell";
          btn.dataset.index = i;
          btn.addEventListener("click", onCellClick);
          boardEl.appendChild(btn);
        }
      }

      function onCellClick(e) {
        const idx = Number(e.currentTarget.dataset.index);
        if (board[idx] || checkWinner(board)) return; // occupied or already won
        board[idx] = current;
        render();

        const winner = checkWinner(board);
        if (winner) {
          statusEl.textContent = `Pemenang: ${winner}`;
          scores[winner]++;
          saveScores();
          scoreXEl.textContent = scores.X;
          scoreOEl.textContent = scores.O;
        } else if (board.every(Boolean)) {
          statusEl.textContent = "Seri!";
        } else {
          current = current === "X" ? "O" : "X";
          turnEl.textContent = current;
        }
      }

      function render() {
        const buttons = boardEl.children;
        for (let i = 0; i < 9; i++) {
          buttons[i].textContent = board[i] || "";
        }
      }

      function checkWinner(b) {
        const lines = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8],
          [0, 4, 8],
          [2, 4, 6],
        ];
        for (const [a, b1, c] of lines) {
          if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
        }
        return null;
      }

      function restart() {
        board = Array(9).fill(null);
        current = "X";
        turnEl.textContent = current;
        statusEl.textContent = "Petunjuk: Klik kotak untuk memainkan.";
        render();
      }

      function saveScores() {
        try {
          localStorage.setItem("ttt-scores", JSON.stringify(scores));
        } catch (e) {}
      }

      restartBtn.addEventListener("click", restart);
      resetScoreBtn.addEventListener("click", () => {
        scores = { X: 0, O: 0 };
        saveScores();
        scoreXEl.textContent = 0;
        scoreOEl.textContent = 0;
      });

      // Initial setup
      createBoard();
      render();

      // --- PWA: service worker registration ---
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
          try {
            await navigator.serviceWorker.register("./sw.js");
            console.log("SW registered");
          } catch (err) {
            console.warn("SW registration failed:", err);
          }
        });
      }

      // --- PWA: install prompt handling ---
      let deferredPrompt = null;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.classList.remove("hidden");
      });
      installBtn.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        if (choice.outcome === "accepted") {
          statusEl.textContent = "Terima kasih — aplikasi bisa dipasang.";
        }
        deferredPrompt = null;
        installBtn.classList.add("hidden");
      });
    </script>
  </body>
</html>
